#!/usr/bin/bash

# Diff the output of the unparser to the output of the cat command, ignoring
# whitespace. We use sed to remove preprocessed headers because these make it
# difficult to do a direct diff.

diff --ignore-all-space --ignore-blank-lines \
    <(clang-17 -fplugin=@CMAKE_BINARY_DIR@/lib/libc_taint.so \
    -fsyntax-only -Xclang -plugin-arg-c_taint_analyzer \
    -Xclang --unparse @CMAKE_SOURCE_DIR@/test/$1 \
        | sed -n -E -e '/sanitize/,$ p') \
    <(cat @CMAKE_SOURCE_DIR@/test/$1 \
        | sed -n -E -e '/sanitize/,$ p')